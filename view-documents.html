<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¨×©×™××ª ××¡××›×™× × ×“×¨×©×™× - Annual Report Documents</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            border: 2px solid #ef5350;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #c62828;
            text-align: center;
        }

        .success-message {
            background: #e8f5e9;
            border: 2px solid #66bb6a;
            border-radius: 8px;
            padding: 20px;
            margin: 0 0 30px 0;
            color: #2e7d32;
            text-align: center;
            font-size: 18px;
        }

        .category {
            margin-bottom: 35px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e0e0e0;
        }

        .category-header {
            font-size: 20px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e3f2fd;
        }

        .document-list {
            list-style: none;
        }

        .document-item {
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
            line-height: 1.6;
        }

        .document-item:last-child {
            border-bottom: none;
        }

        .document-item::before {
            content: "ğŸ“„";
            margin-left: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        .status-missing {
            background: #fff3cd;
            color: #856404;
        }

        .status-received {
            background: #d4edda;
            color: #155724;
        }

        .status-fix {
            background: #f8d7da;
            color: #721c24;
        }

        .contact-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
        }

        .contact-box h3 {
            color: #1565c0;
            margin-bottom: 12px;
            font-size: 20px;
        }

        .contact-box p {
            color: #424242;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .email-link {
            display: inline-block;
            background: #1976d2;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
        }

        .email-link:hover {
            background: #1565c0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
        }

        .lang-toggle {
            text-align: center;
            margin: 20px 0;
        }

        .lang-button {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .lang-button.active {
            background: #1976d2;
            color: white;
            border-color: #1976d2;
        }

        .lang-button:hover {
            border-color: #1976d2;
        }

        [dir="ltr"] .document-item::before {
            margin-left: 0;
            margin-right: 10px;
        }

        [dir="ltr"] .status-badge {
            margin-right: 0;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title-he">×¨×©×™××ª ××¡××›×™× × ×“×¨×©×™×</h1>
            <h1 id="title-en" style="display: none;">Required Documents List</h1>
            <div class="subtitle" id="subtitle"></div>
        </div>

        <div class="content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loading-text-he">×˜×•×¢×Ÿ ××ª ×¨×©×™××ª ×”××¡××›×™×...</p>
                <p id="loading-text-en" style="display: none;">Loading document list...</p>
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="results" style="display: none;">
                <div class="lang-toggle">
                    <button class="lang-button active" id="btn-he" onclick="switchLanguage('he')">×¢×‘×¨×™×ª</button>
                    <button class="lang-button" id="btn-en" onclick="switchLanguage('en')">English</button>
                </div>

                <div id="documents-container"></div>

                <div class="contact-box">
                    <h3 id="contact-title-he">××™×š ×©×•×œ×—×™× ××ª ×”××¡××›×™×?</h3>
                    <h3 id="contact-title-en" style="display: none;">How to Submit Documents?</h3>
                    
                    <p id="contact-text-he">
                        ×©×œ×—×• ××ª ×”××¡××›×™× ×‘××™×™×œ ×‘×§×•×‘×¥ ××¦×•×¨×£:<br>
                        <strong id="email-display"></strong>
                    </p>
                    <p id="contact-text-en" style="display: none;">
                        Send the documents via email as attachments:<br>
                        <strong id="email-display-en"></strong>
                    </p>
                    
                    <a href="#" id="email-button" class="email-link">ğŸ“§ ×©×œ×™×—×ª ××™×™×œ</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentLang = 'he';

        // Get report_id from URL
        const params = new URLSearchParams(window.location.search);
        const reportId = params.get('report_id');

        if (!reportId) {
            showError('×—×¡×¨ ××–×”×” ×“×•×— / Missing report ID');
        } else {
            loadDocuments();
        }

        async function loadDocuments() {
            try {
                const response = await fetch(`https://liozshor.app.n8n.cloud/webhook/get-client-documents?report_id=${reportId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load documents');
                }

                const data = await response.json();
                currentData = data;

                document.getElementById('loading').style.display = 'none';

                if (!data.ok) {
                    showError(data.error || '×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¡××›×™× / Error loading documents');
                    return;
                }

                // Update subtitle
                const subtitleHe = `${data.client_name} â€¢ ×©× ×ª ××¡ ${data.year}`;
                const subtitleEn = `${data.client_name} â€¢ Tax Year ${data.year}`;
                document.getElementById('subtitle').innerHTML = `
                    <span id="subtitle-he">${subtitleHe}</span>
                    <span id="subtitle-en" style="display: none;">${subtitleEn}</span>
                `;

                // Set email
                const email = data.support_email || 'reports@moshe-atsits.co.il';
                document.getElementById('email-display').textContent = email;
                document.getElementById('email-display-en').textContent = email;
                document.getElementById('email-button').href = `mailto:${email}?subject=××¡××›×™× ×œ×“×•×— ×©× ×ª×™ ${data.year} - ${data.client_name}`;

                // Set default language
                currentLang = data.source_language || 'he';
                
                renderDocuments();
                document.getElementById('results').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¡××›×™× / Error loading documents');
            }
        }

        function renderDocuments() {
            if (!currentData || !currentData.categories) return;

            const container = document.getElementById('documents-container');
            
            if (currentData.document_count === 0) {
                container.innerHTML = currentLang === 'he' 
                    ? '<div class="success-message">âœ… ×›×œ ×”××¡××›×™× ×”×ª×§×‘×œ×•! ××™×Ÿ ××¡××›×™× ×—×¡×¨×™×.</div>'
                    : '<div class="success-message">âœ… All documents received! No missing documents.</div>';
                return;
            }

            let html = '';

            for (const category of currentData.categories) {
                const categoryName = currentLang === 'he' ? category.category_he : category.category_en;
                
                html += `<div class="category">`;
                html += `<div class="category-header">${categoryName}</div>`;
                html += `<ul class="document-list">`;

                for (const doc of category.documents) {
                    const docName = currentLang === 'he' ? doc.name_he : doc.name_en;
                    
                    // Apply smart formatting (bold after dashes)
                    const formattedName = formatDocumentName(docName);
                    
                    let statusBadge = '';
                    if (doc.status === 'Received') {
                        statusBadge = currentLang === 'he' 
                            ? '<span class="status-badge status-received">×”×ª×§×‘×œ</span>'
                            : '<span class="status-badge status-received">Received</span>';
                    } else if (doc.status === 'Requires_Fix') {
                        statusBadge = currentLang === 'he'
                            ? '<span class="status-badge status-fix">×“×•×¨×© ×ª×™×§×•×Ÿ</span>'
                            : '<span class="status-badge status-fix">Needs Fix</span>';
                    } else {
                        statusBadge = currentLang === 'he'
                            ? '<span class="status-badge status-missing">× ×“×¨×©</span>'
                            : '<span class="status-badge status-missing">Required</span>';
                    }

                    html += `<li class="document-item">${statusBadge}${formattedName}</li>`;
                }

                html += `</ul></div>`;
            }

            container.innerHTML = html;
        }

        function formatDocumentName(name) {
            // Bold parts after dashes (names, companies, banks)
            const parts = String(name || '').split(' - ');
            if (parts.length === 1) return name;
            
            const formatted = [parts[0]];
            for (let i = 1; i < parts.length; i++) {
                formatted.push(`<strong>${parts[i]}</strong>`);
            }
            
            return formatted.join(' - ');
        }

        function switchLanguage(lang) {
            currentLang = lang;
            const isHe = lang === 'he';

            // Toggle direction
            document.documentElement.dir = isHe ? 'rtl' : 'ltr';
            document.documentElement.lang = isHe ? 'he' : 'en';

            // Toggle buttons
            document.getElementById('btn-he').classList.toggle('active', isHe);
            document.getElementById('btn-en').classList.toggle('active', !isHe);

            // Toggle titles
            document.getElementById('title-he').style.display = isHe ? 'block' : 'none';
            document.getElementById('title-en').style.display = isHe ? 'none' : 'block';

            document.getElementById('subtitle-he').style.display = isHe ? 'inline' : 'none';
            document.getElementById('subtitle-en').style.display = isHe ? 'none' : 'inline';

            // Toggle loading texts
            document.getElementById('loading-text-he').style.display = isHe ? 'block' : 'none';
            document.getElementById('loading-text-en').style.display = isHe ? 'none' : 'block';

            // Toggle contact section
            document.getElementById('contact-title-he').style.display = isHe ? 'block' : 'none';
            document.getElementById('contact-title-en').style.display = isHe ? 'none' : 'block';
            document.getElementById('contact-text-he').style.display = isHe ? 'block' : 'none';
            document.getElementById('contact-text-en').style.display = isHe ? 'none' : 'block';

            // Update email button text
            document.getElementById('email-button').textContent = isHe ? 'ğŸ“§ ×©×œ×™×—×ª ××™×™×œ' : 'ğŸ“§ Send Email';

            // Re-render documents
            renderDocuments();
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
