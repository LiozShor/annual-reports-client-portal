{
  "name": "[1] send_questionnaire",
  "nodes": [
    {
      "parameters": {
        "path": "trigger-survey",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        4624,
        816
      ],
      "id": "8ee1458b-eeec-48c5-a9d5-2b77fc24ef2f",
      "name": "Webhook",
      "webhookId": "11b2e70a-3e17-4138-8076-13e05bc812e5"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tbls7m3hmHC4hhQVy",
          "mode": "id"
        },
        "options": {
          "view": {
            "__rl": true,
            "value": "viwqwyIxD46HXxMEX",
            "mode": "list",
            "cachedResultName": "stage 1 - send questionnare ",
            "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh/tbls7m3hmHC4hhQVy/viwqwyIxD46HXxMEX"
          }
        }
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        4848,
        816
      ],
      "id": "bc3c8dd5-110e-43f3-bb1d-bc46358291dd",
      "name": "Airtable",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "base": {
          "__rl": true,
          "mode": "id",
          "value": "appqBL5RWQN9cPOyh"
        },
        "table": {
          "__rl": true,
          "mode": "id",
          "value": "tblFFttFScDRZ7Ah5"
        },
        "id": "={{ $json.client[0] }}",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        5072,
        816
      ],
      "id": "9a5e7a1b-a9e0-47dd-bb00-ce4627f95605",
      "name": "Get Client",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const i = $itemIndex;\n\n// 1) Current client item (input of this node)\nconst clientRaw = $input.item?.json || {};\nconst c = clientRaw.fields || clientRaw;\n\n// 2) Report item from the first Airtable node in the workflow\nconst reportAll = $(\"Airtable\").all();\nif (!reportAll[i]) {\n  throw new Error(`Missing Airtable report item for index ${i}`);\n}\n\nconst reportItem = reportAll[i]?.json || {};\nconst reportRecordId = reportItem.id || (reportItem.fields ? reportItem.fields.id : undefined);\n\nif (!reportRecordId || reportRecordId === \"undefined\") {\n  throw new Error(\n    `Critical: report_record_id is undefined for index ${i}. Check Airtable node output.`\n  );\n}\n\nfunction norm(v) {\n  return String(v ?? \"\").trim();\n}\n\n// Extract client_id from multiple possible locations\nlet clientId = norm(c.client_id) || norm(c.id) || norm(clientRaw.id);\n\n// If still empty, try to get from report\nif (!clientId) {\n  clientId = norm(reportItem.client_id);\n}\n\n// Last resort: use record ID\nif (!clientId) {\n  clientId = reportRecordId;\n  console.log(`Warning: Using report_record_id as client_id fallback`);\n}\n\nconst clientName = norm(c.name) || norm(c.client_name);\nconst clientEmail = norm(c.email) || norm(c.client_email);\nconst year = norm(reportItem.year);\nconst token = norm(reportItem.questionnaire_token);\n\n// Build the landing page URL (not direct to Tally anymore)\nconst landingPageUrl = `https://liozshor.github.io/annual-reports-client-portal/?report_id=${reportRecordId}&client_id=${clientId}&year=${year}&token=${token}&full_name=${encodeURIComponent(clientName)}&email=${encodeURIComponent(clientEmail)}`;\n\nreturn {\n  json: {\n    email: clientEmail,\n    name: clientName,\n    year: year,\n    client_id: clientId,\n    landing_page_link: landingPageUrl\n  },\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5296,
        816
      ],
      "id": "0514c57b-5ea0-44fa-9a5a-b3eebc228c5c",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tbls7m3hmHC4hhQVy",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Airtable').item.json.id }}",
            "stage": "2-Waiting_For_Answers",
            "last_progress_check_at": "={{ $now }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false
            },
            {
              "id": "report_key",
              "displayName": "report_key",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "client",
              "displayName": "client",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "array",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "send_questionnaire",
              "displayName": "send_questionnaire",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "year",
              "displayName": "year",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "stage",
              "displayName": "stage",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "options",
              "options": [
                {
                  "name": "1-Send_Questionnaire",
                  "value": "1-Send_Questionnaire"
                },
                {
                  "name": "2-Waiting_For_Answers",
                  "value": "2-Waiting_For_Answers"
                },
                {
                  "name": "3-Collecting_Docs",
                  "value": "3-Collecting_Docs"
                },
                {
                  "name": "4-Review",
                  "value": "4-Review"
                },
                {
                  "name": "5-Completed",
                  "value": "5-Completed"
                }
              ],
              "readOnly": false,
              "removed": false
            },
            {
              "id": "questionnaire_token",
              "displayName": "questionnaire_token",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "report_uid",
              "displayName": "report_uid",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "questionnaire_link_he",
              "displayName": "questionnaire_link_he",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "questionnaire_link_en",
              "displayName": "questionnaire_link_en",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "last_progress_check_at",
              "displayName": "last_progress_check_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "documents",
              "displayName": "documents",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "array",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email_events",
              "displayName": "email_events",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "array",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "docs_total",
              "displayName": "docs_total",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "docs_missing_count",
              "displayName": "docs_missing_count",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "docs_received_count",
              "displayName": "docs_received_count",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "completion_percent",
              "displayName": "completion_percent",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "completion_status_auto",
              "displayName": "completion_status_auto",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "client_id",
              "displayName": "client_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        5744,
        816
      ],
      "id": "72742cef-563d-40c9-87a6-d3494e5a333a",
      "name": "Update record",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{(() => {\n  const recipients = $items(\"Code in JavaScript\").map(i => ({\n    name: i.json.name,\n    email: i.json.email,\n    year: i.json.year,\n  }));\n\n  const listItems = recipients\n    .map(r => `<li>â€¢ ${r.name} <span style=\"color:#777\">( ${r.email} )</span></li>`)\n    .join(\"\");\n\n  return `<!DOCTYPE html>\n<html lang=\"he\" dir=\"rtl\">\n<head>\n  <meta charset=\"utf-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n  <style>\n    body { font-family: Arial, sans-serif; max-width: 700px; margin: 50px auto; padding: 20px; direction: rtl; text-align: right; }\n    h1 { color: #4CAF50; margin-top: 0; }\n    ul { list-style-type: none; padding: 0; margin: 16px 0; }\n    li { padding: 10px 12px; background: #f5f5f5; margin: 8px 0; border-radius: 6px; }\n    .meta { color: #666; }\n    .ltr { direction: ltr; unicode-bidi: bidi-override; display: inline-block; }\n  </style>\n</head>\n<body>\n  <h1>âœ… ×”×©××œ×•× ×™× × ×©×œ×—×• ×‘×”×¦×œ×—×”!</h1>\n  <p class=\"meta\">×”×œ×§×•×—×•×ª ×”×‘××™× ×§×™×‘×œ×• ××ª ×”×©××œ×•×Ÿ ×œ×“×•×— ×”×©× ×ª×™:</p>\n  <ul>${listItems || \"<li>â€¢ ×œ× × ××¦××• × ××¢× ×™×</li>\"}</ul>\n  <p><strong>×¡×”×´×› × ×©×œ×—×•: ${recipients.length}</strong></p>\n</body>\n</html>`;\n})()}}\n",
        "options": {
          "responseCode": 200
        }
      },
      "id": "0a9a6ef4-c260-48d8-b772-861bcb28e4c4",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        5968,
        816
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.microsoft.com/v1.0/me/sendMail",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"message\": {\n    \"subject\": \"×©××œ×•×Ÿ ×“×•×— ×©× ×ª×™ {{$json.year}} | {{$json.name}}\",\n    \"body\": {\n      \"contentType\": \"HTML\",\n      \"content\": \"<div dir='rtl' style='font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; color: #333;'> <div style='background-color: #f8f9fa; padding: 20px; text-align: center; border-bottom: 2px solid #0056b3;'> <h2 style='color: #0056b3; margin: 0;'>×©××œ×•×Ÿ ×“×•×— ×©× ×ª×™ {{$json.year}}</h2> </div> <div style='padding: 30px; line-height: 1.6;'> <p style='font-size: 16px;'>×©×œ×•× <strong>{{$json.name}}</strong>,</p> <p style='font-size: 15px;'>×œ×¦×•×¨×š ×”×›× ×ª ×”×“×•×— ×”×©× ×ª×™ ×œ×©× ×ª <strong>{{$json.year}}</strong>, × ×‘×§×©×š ×œ××œ× ××ª ×”×©××œ×•×Ÿ:</p> <div style='text-align: center; margin: 25px 0;'> <a href='https://liozshor.github.io/annual-reports-client-portal/?report_id={{ $('Airtable').item.json.id }}&client_id={{ $json.client_id }}&year={{ $json.year }}&token={{ $('Airtable').item.json.questionnaire_token }}&full_name={{ encodeURIComponent($json.name) }}&email={{ encodeURIComponent($json.email) }}' style='background-color: #0056b3; color: white; padding: 14px 30px; text-decoration: none; border-radius: 5px; font-weight: bold; display: inline-block; font-size: 16px;'>ğŸ“‹ ××œ× ×©××œ×•×Ÿ / Fill Questionnaire</a> </div> <p style='font-size: 14px; color: #777; text-align: center; margin-top: 15px;'>×”×©××œ×•×Ÿ ×–××™×Ÿ ×‘×¢×‘×¨×™×ª ×•×‘×× ×’×œ×™×ª | Questionnaire available in Hebrew and English</p> <hr style='border: 0; border-top: 1px solid #eee; margin: 30px 0;'> <div dir='ltr' style='text-align: left;'> <p style='font-size: 15px;'>For the preparation of the <strong>{{$json.year}}</strong> annual tax report, please fill out the questionnaire using the link above.</p> </div> <p style='font-size: 15px; margin-top: 40px;'>×‘×‘×¨×›×”,<br><strong>××©×¨×“ ××©×” ×¢×¦×™×¥</strong></p> </div> <div style='background-color: #f1f1f1; padding: 15px; text-align: center; font-size: 12px; color: #777;'> ×–×”×• ××™×™×œ ××•×˜×•××˜×™ ×©× ×©×œ×— ×œ×¦×•×¨×š ××™×¡×•×£ × ×ª×•× ×™× ×œ×“×•×— ×”×©× ×ª×™. </div> </div>\"\n    },\n    \"toRecipients\": [\n      {\n        \"emailAddress\": {\n          \"address\": \"{{$json.email}}\"\n        }\n      }\n    ]\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5520,
        816
      ],
      "id": "0927673d-e8bb-4a3b-8aa5-23f7108b5c19",
      "name": "HTTP Request",
      "credentials": {
        "oAuth2Api": {
          "id": "GcLQZwzH2xj41sV7",
          "name": "MS_Graph_CPA_Automation"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable": {
      "main": [
        [
          {
            "node": "Get Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Client": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update record": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Update record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": true
  },
  "staticData": null,
  "pinData": {},
  "triggerCount": 1,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}