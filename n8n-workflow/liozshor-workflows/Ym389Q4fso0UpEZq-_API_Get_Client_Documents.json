{
  "name": "[API] Get Client Documents",
  "nodes": [
    {
      "parameters": {
        "path": "get-client-documents",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -1264,
        45264
      ],
      "id": "da227851-0d6d-4701-823b-d1365036ffff",
      "webhookId": "get-client-docs"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.query.report_id }}",
              "operation": "isNotEmpty"
            }
          ]
        },
        "options": {}
      },
      "name": "IF Has report_id",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1040,
        45264
      ],
      "id": "89be5624-6291-4abc-957c-009c16c9efc6"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { ok: false, error: 'MISSING_REPORT_ID' } }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "name": "Respond Missing report_id",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -816,
        45408
      ],
      "id": "01cacf7e-abec-4f87-86f2-dd95bc72750b"
    },
    {
      "parameters": {
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tbls7m3hmHC4hhQVy",
          "mode": "id"
        },
        "id": "={{ $json.query.report_id }}",
        "options": {}
      },
      "name": "Get Report",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        -816,
        45120
      ],
      "id": "7339896d-da1e-47b9-8a05-98f88213a4f2",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblcwptR63skeODPn",
          "mode": "id"
        },
        "filterByFormula": "={{ `AND(\n  FIND('${$node[\"Webhook\"].json.query.report_id}', ARRAYJOIN({report_record_id})),\n  {status} != 'Waived',\n  {status} != 'Removed'\n)` }}",
        "options": {}
      },
      "name": "Search Documents",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        -592,
        45120
      ],
      "id": "3f0a412d-f443-47da-9ebe-c162b8f45b0d",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ========== BUILD JSON RESPONSE FOR view-documents.html ==========\n\nconst report = $('Get Report').first().json;\nconst docs = $('Search Documents').all();\n\n// Extract report info\nconst year = report.year ?? '';\nconst clientName = Array.isArray(report.client_name) ? report.client_name[0] : report.client_name || '';\nconst spouseName = Array.isArray(report.spouse_name) ? report.spouse_name[0] : report.spouse_name || '';\nconst sourceLanguage = Array.isArray(report.source_language) ? report.source_language[0] : report.source_language || 'he';\n\n// Category mappings\nconst TYPE_TO_CATEGORY = {\n  Form_106: 'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n  Form_106_Spouse: 'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n  Inventory_List: 'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n  Form_867: 'ğŸ¦ ×‘× ×§×™× ×•×©×•×§ ×”×”×•×Ÿ',\n  Crypto_Report: 'ğŸ¦ ×‘× ×§×™× ×•×©×•×§ ×”×”×•×Ÿ',\n  NII_Allowance_Cert: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  NII_Allowance_Cert_Spouse: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  Insurance_Tax_Cert: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  Pension_Withdrawal: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  Residency_Cert: 'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n  Rent_Contract_Income: 'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n  Rent_Contract_Expense: 'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n  ID_Appendix: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Child_ID_Appendix: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Donation_Receipts: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Memorial_Receipts: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Institution_Approval: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Degree_Cert: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Medical_Committee: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Army_Release_Cert: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Special_Ed_Approval: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Child_Disability_Approval: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Alimony_Judgment: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Gambling_Win_Cert: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  Foreign_Income_Report: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  WHT_Approval_IncomeTax: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  WHT_Approval_NII: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  General_Doc: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  Mortgage_Insurance_Cert: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n};\n\n// Group documents by category\nconst grouped = {};\nfor (const d of docs) {\n  const type = d.json.type || '';\n  const cat = TYPE_TO_CATEGORY[type] || 'ğŸ“‹ ××—×¨';\n  \n  if (!grouped[cat]) grouped[cat] = [];\n  \n  grouped[cat].push({\n    name_he: d.json.issuer_name || d.json.type || '××¡××š × ×“×¨×©',\n    name_en: d.json.issuer_name_en || d.json.type || 'Required Document',\n    status: d.json.status || 'Required_Missing',\n    type: type\n  });\n}\n\nreturn [{\n  json: {\n    ok: true,\n    report: {\n      year: String(year),\n      client_name: String(clientName),\n      spouse_name: String(spouseName),\n      source_language: String(sourceLanguage)\n    },\n    documents: grouped,\n    document_count: docs.length\n  }\n}];"
      },
      "name": "Build Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        45120
      ],
      "id": "4aca5e5a-3d8c-4b5c-baf2-4f279e14e5b6"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -160,
        45120
      ],
      "id": "d6d1ea2c-3c82-45bf-888e-dc6d8dda4147"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "IF Has report_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Has report_id": {
      "main": [
        [
          {
            "node": "Get Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond Missing report_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Report": {
      "main": [
        [
          {
            "node": "Search Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Documents": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Response": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "liozshor.app.n8n.cloud",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
            "accept": "*/*",
            "accept-encoding": "gzip, br",
            "accept-language": "he-IL,he;q=0.9,en-US;q=0.8,en;q=0.7",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "2a00:a040:192:6db7:c193:9c0b:66cc:c2d7",
            "cf-ew-via": "15",
            "cf-ipcountry": "IL",
            "cf-ray": "9c04a3ca95787863-LHR",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "origin": "https://liozshor.github.io",
            "priority": "u=1, i",
            "referer": "https://liozshor.github.io/",
            "sec-ch-ua": "\"Google Chrome\";v=\"143\", \"Chromium\";v=\"143\", \"Not A(Brand\";v=\"24\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "2a00:a040:192:6db7:c193:9c0b:66cc:c2d7, 172.68.229.26",
            "x-forwarded-host": "liozshor.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-15-6cb64f5ddc-wtj5h",
            "x-is-trusted": "yes",
            "x-real-ip": "2a00:a040:192:6db7:c193:9c0b:66cc:c2d7"
          },
          "params": {},
          "query": {
            "report_id": "reci3TDgN6R42hhTl"
          },
          "body": {},
          "webhookUrl": "https://liozshor.app.n8n.cloud/webhook/get-client-documents",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "triggerCount": 1,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}