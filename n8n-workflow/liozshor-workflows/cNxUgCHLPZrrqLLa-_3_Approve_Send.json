{
  "name": "[3] Approve & Send",
  "nodes": [
    {
      "parameters": {
        "path": "approve-and-send",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        5008,
        -64
      ],
      "id": "1c75fb7c-7ec0-480d-a330-87f70e09787e",
      "name": "Webhook - Approve",
      "webhookId": "1421b63d-c0ca-4149-b5ee-3ba28f1f178d"
    },
    {
      "parameters": {
        "jsCode": "// ×©×™××•×© ×‘-.first() ××‘×˜×™×— ×©×œ×™×¤×” × ×§×™×™×” ×’× ×× ×”-Pairing × ×©×‘×¨\nconst config = $(\"Global Config\").first().json;\nconst SECRET = String(config.WEBHOOK_SECRET || \"\").trim();\n\nconst webhookData = $(\"Webhook - Approve\").first().json;\nconst q = webhookData.query || {};\n\nconst report_id = q.report_id;\nconst token = String(q.token || \"\").trim();\n\n// ×‘×“×™×§×” ×× ×”-ID ×§×™×™×\nif (!report_id) {\n  throw new Error('Unauthorized: Missing report_id');\n}\n\n// ×‘×“×™×§×ª ×”×˜×•×§×Ÿ ××•×œ ×”×¡×•×“\nif (!token || token !== SECRET) {\n  throw new Error('Unauthorized: Invalid or missing token');\n}\n\nreturn [{ json: { report_id } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5456,
        -64
      ],
      "id": "ae8682fe-7d58-409d-8890-8bc8219da35f",
      "name": "Verify Token"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "list",
          "cachedResultName": "Annual Reports CRM",
          "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh"
        },
        "table": {
          "__rl": true,
          "value": "tblcwptR63skeODPn",
          "mode": "list",
          "cachedResultName": "documents",
          "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh/tblcwptR63skeODPn"
        },
        "filterByFormula": "=AND(\n  FIND('{{ $('Verify Token').item.json.report_id }}', ARRAYJOIN({report_record_id})), \n  {status}='Required_Missing'\n)",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        6128,
        32
      ],
      "id": "3fa94c84-8184-4e53-8458-c39814ff9de1",
      "name": "Airtable - List Docs",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all().map(i => i.json);\n\nreturn [{\n  json: {\n    count: items.length,\n    docs: items.map(d => d.issuer_name).filter(Boolean),\n    docsFull: items\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6352,
        32
      ],
      "id": "00412182-cb54-4189-beb3-17205bfcbd0d",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "jsCode": "// HTML Generator (BILINGUAL v7 - SMART FORMATTING)\n// Reads plain-text names from Airtable and applies smart formatting\n\nfunction escHtml(s) {\n  return String(s ?? '')\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n}\n\n// ========== SMART FORMATTING FOR DOCUMENT NAMES ==========\nfunction formatDocumentName(name) {\n  // Bold parts after dashes (names, companies, banks, etc.)\n  // Example: \"×˜×•×¤×¡ 106 - ×œ×™×¢×•×– - ×§×¤×” ××¢×¡×™×§\" \n  // Becomes: \"×˜×•×¤×¡ 106 - <strong>×œ×™×¢×•×–</strong> - <strong>×§×¤×” ××¢×¡×™×§</strong>\"\n  \n  const parts = String(name || '').split(' - ');\n  if (parts.length === 1) return escHtml(name); // No dashes, return escaped\n  \n  // Keep first part plain, bold the rest\n  const formatted = [escHtml(parts[0])];\n  for (let i = 1; i < parts.length; i++) {\n    formatted.push(`<strong>${escHtml(parts[i])}</strong>`);\n  }\n  \n  return formatted.join(' - ');\n}\n\nfunction pickFirst(v) {\n  return Array.isArray(v) ? v[0] : v;\n}\n\nfunction norm(s) {\n  return String(s ?? '').trim();\n}\n\n// ========== TRANSLATION MAPPINGS ==========\nconst CATEGORY_HE_TO_EN = {\n  'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”': 'ğŸ’¼ Employment Income',\n  'ğŸ¦ ×‘× ×§×™× ×•×©×•×§ ×”×”×•×Ÿ': 'ğŸ¦ Banks & Capital Markets',\n  'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª': 'ğŸ›¡ï¸ Insurance, Pension & Benefits',\n  'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ': 'ğŸ  Housing & Real Estate',\n  'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª': 'ğŸ“‹ Personal & Donations',\n  'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª': 'ğŸ’° Additional Income',\n  'ğŸ“‹ ××—×¨': 'ğŸ“‹ Other',\n};\n\n// Fallback English names (only if issuer_name_en is missing)\nconst TYPE_TO_NAME_EN = {\n  Form_106: 'Form 106 (Annual Employer Tax Certificate)',\n  Form_106_Spouse: \"Form 106 (Spouse's Annual Employer Tax Certificate)\",\n  Inventory_List: 'Business Inventory List',\n  Form_867: 'Form 867 (Bank/Securities Tax Certificate)',\n  Crypto_Report: 'Cryptocurrency Transaction Report',\n  NII_Allowance_Cert: 'National Insurance Annual Certificate',\n  NII_Allowance_Cert_Spouse: 'National Insurance Annual Certificate (Spouse)',\n  Insurance_Tax_Cert: 'Insurance Tax Certificate',\n  Pension_Withdrawal: 'Pension/Provident Fund Withdrawal Certificate',\n  Residency_Cert: 'Municipality Residency Certificate',\n  Rent_Contract_Income: 'Rental Income Lease Agreement',\n  Rent_Contract_Expense: 'Rental Expense Lease Agreement',\n  ID_Appendix: 'ID Appendix',\n  Child_ID_Appendix: 'ID Appendix (with Children)',\n  Donation_Receipts: 'Donation Receipts (Section 46)',\n  Memorial_Receipts: 'Memorial Expense Receipts',\n  Institution_Approval: 'Institution Care Documentation',\n  Degree_Cert: 'Degree Eligibility Certificate',\n  Medical_Committee: 'Medical Committee Documentation',\n  Army_Release_Cert: 'Military Release Certificate',\n  Special_Ed_Approval: 'Special Education Approval',\n  Child_Disability_Approval: 'Child Disability Allowance Certificate',\n  Alimony_Judgment: 'Divorce Agreement / Alimony Judgment',\n  Gambling_Win_Cert: 'Gambling/Prize Winnings Certificate',\n  Foreign_Income_Report: 'Foreign Income Documentation',\n  WHT_Approval_IncomeTax: 'Withholding Tax Certificate (Income Tax)',\n  WHT_Approval_NII: 'Withholding Tax Certificate (National Insurance)',\n  General_Doc: 'Supporting Document',\n  Mortgage_Insurance_Cert: 'Mortgage Insurance Certificate',\n};\n\n// ---------- 1) Get docs ----------\nconst docsPack = $('Code in JavaScript').first().json || {};\nconst docItems = Array.isArray(docsPack.docsFull) ? docsPack.docsFull : [];\n\n// ---------- 2) Get report data ----------\nconst report = $('Get a record').first().json || {};\nconst year = report.year ?? '';\nconst clientName = pickFirst(report.client_name) || '';\nconst spouseName = pickFirst(report.spouse_name) || '';\nlet clientEmail = pickFirst(report.client_email) || '';\n\nclientEmail = String(clientEmail).trim();\nif (!clientEmail) {\n  throw new Error('Missing client_email on annual report record');\n}\n\nconst source_language = pickFirst(report.source_language) || 'he';\nconst isMarried = String(spouseName).trim().length > 0;\n\n// report_id from Verify Token\nconst report_record_id = $('Verify Token').first().json?.report_id;\n\n// ---------- 3) Mappings ----------\nconst TYPE_TO_CATEGORY = {\n  Form_106: 'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n  Form_106_Spouse: 'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n  Inventory_List: 'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n\n  Form_867: 'ğŸ¦ ×‘× ×§×™× ×•×©×•×§ ×”×”×•×Ÿ',\n  Crypto_Report: 'ğŸ¦ ×‘× ×§×™× ×•×©×•×§ ×”×”×•×Ÿ',\n\n  NII_Allowance_Cert: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  NII_Allowance_Cert_Spouse: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  Insurance_Tax_Cert: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  Pension_Withdrawal: 'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n\n  Residency_Cert: 'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n  Rent_Contract_Income: 'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n  Rent_Contract_Expense: 'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n\n  ID_Appendix: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Child_ID_Appendix: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Donation_Receipts: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Memorial_Receipts: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Institution_Approval: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Degree_Cert: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Medical_Committee: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Army_Release_Cert: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Special_Ed_Approval: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Child_Disability_Approval: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  Alimony_Judgment: 'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n\n  Gambling_Win_Cert: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  Foreign_Income_Report: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  WHT_Approval_IncomeTax: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  WHT_Approval_NII: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  General_Doc: 'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n};\n\nconst CATEGORY_ORDER = [\n  'ğŸ’¼ ×”×›× ×¡×•×ª ××¢×‘×•×“×”',\n  'ğŸ¦ ×‘× ×§×™× ×•×©×•×§ ×”×”×•×Ÿ',\n  'ğŸ›¡ï¸ ×‘×™×˜×•×—, ×¤× ×¡×™×” ×•×§×¦×‘××•×ª',\n  'ğŸ  ××’×•×¨×™× ×•× ×“×œ\"×Ÿ',\n  'ğŸ“‹ ××™×©×™ ×•×ª×¨×•××•×ª',\n  'ğŸ’° ×”×›× ×¡×•×ª × ×•×¡×¤×•×ª',\n  'ğŸ“‹ ××—×¨',\n];\n\n// ---------- 4) Group by Category ----------\nconst grouped = {};\nfor (const d of docItems) {\n  const type = norm(d.type);\n  const cat = TYPE_TO_CATEGORY[type] || 'ğŸ“‹ ××—×¨';\n  if (!grouped[cat]) grouped[cat] = [];\n\n  const hebrewName = d.issuer_name || d.type || '××¡××š × ×“×¨×©';\n  const englishName = d.issuer_name_en || TYPE_TO_NAME_EN[type] || 'Required Document';\n\n  grouped[cat].push({\n    name_he: hebrewName,\n    name_en: englishName,\n    type,\n  });\n}\n\n// ---------- 5) Render ----------\nfunction renderDocList(docs, lang) {\n  const items = docs\n    .map((doc) => {\n      const displayText = lang === 'en' ? doc.name_en : doc.name_he;\n      // Apply smart formatting for both languages\n      const formatted = formatDocumentName(displayText);\n      return `<li style=\"padding:4px 0; line-height:1.4;\">â€¢ ${formatted}</li>`;\n    })\n    .join('');\n\n  const padSide = lang === 'en' ? 'left' : 'right';\n  return `<ul style=\"margin:5px 0 0 0; padding-${padSide}:18px;\">${items}</ul>`;\n}\n\nfunction renderCategoryGeneric(cat, docs, lang) {\n  const catName = lang === 'en' ? (CATEGORY_HE_TO_EN[cat] || cat) : cat;\n\n  let contentHtml = '';\n\n  const sortFn =\n    lang === 'en'\n      ? (a, b) => String(a.name_en).localeCompare(String(b.name_en))\n      : (a, b) => String(a.name_he).localeCompare(String(b.name_he), 'he');\n\n  if (isMarried) {\n    const clientDocs = [];\n    const spouseDocs = [];\n    const sharedDocs = [];\n\n    for (const doc of docs) {\n      if (doc.type.includes('Spouse')) spouseDocs.push(doc);\n      else if (doc.type.includes('Child') || doc.type.includes('Shared')) sharedDocs.push(doc);\n      else clientDocs.push(doc);\n    }\n\n    clientDocs.sort(sortFn);\n    spouseDocs.sort(sortFn);\n    sharedDocs.sort(sortFn);\n\n    if (clientDocs.length) {\n      contentHtml += `<div style=\"margin-bottom: 8px;\"><strong style=\"color:#1976d2; font-size:14px;\">${escHtml(\n        clientName\n      )}:</strong>${renderDocList(clientDocs, lang)}</div>`;\n    }\n\n    if (spouseDocs.length) {\n      contentHtml += `<div style=\"margin-bottom: 8px;\"><strong style=\"color:#7b1fa2; font-size:14px;\">${escHtml(\n        spouseName\n      )} (${lang === 'en' ? 'Spouse' : '×‘×Ÿ/×‘×ª ×–×•×’'}):</strong>${renderDocList(spouseDocs, lang)}</div>`;\n    }\n\n    if (sharedDocs.length) {\n      contentHtml += `<div style=\"margin-bottom: 8px;\">${renderDocList(sharedDocs, lang)}</div>`;\n    }\n  } else {\n    docs.sort(sortFn);\n    contentHtml = renderDocList(docs, lang);\n  }\n\n  return `\n    <div style=\"margin-bottom:18px;\">\n      <h3 style=\"margin:0 0 10px 0; color:#1976d2; font-size:16px; border-bottom:1px solid #e6eef7; padding-bottom:6px;\">\n        ${escHtml(catName)}\n      </h3>\n      ${contentHtml}\n    </div>`;\n}\n\n// Order categories\nconst catsSorted = Object.keys(grouped).sort((a, b) => {\n  const ia = CATEGORY_ORDER.indexOf(a);\n  const ib = CATEGORY_ORDER.indexOf(b);\n  if (ia === -1 && ib === -1) return a.localeCompare(b, 'he');\n  if (ia === -1) return 1;\n  if (ib === -1) return -1;\n  return ia - ib;\n});\n\nconst hebrewBlock = catsSorted.map((cat) => renderCategoryGeneric(cat, grouped[cat], 'he')).join('');\nconst englishBlock =\n  source_language === 'en' ? catsSorted.map((cat) => renderCategoryGeneric(cat, grouped[cat], 'en')).join('') : '';\n\nconst finalHeBlock = docItems.length\n  ? hebrewBlock\n  : `<div style=\"padding:12px; background:#e8f5e9; border:1px solid #c8e6c9;\">×œ× × ××¦××• ××¡××›×™× ×—×¡×¨×™×.</div>`;\n\nconst finalEnBlock = docItems.length\n  ? englishBlock\n  : `<div style=\"padding:12px; background:#e8f5e9; border:1px solid #c8e6c9;\">No missing documents found.</div>`;\n\n// ========== BUILD EMAIL BODY ==========\nconst footerStyle = 'margin-top:16px; font-size:12px; color:#666; text-align:center;';\nconst linkStyle = 'color:#1976d2; text-decoration:none;';\nconst containerStyle =\n  'font-family: Arial, sans-serif; color:#222; line-height:1.5; max-width:680px; margin:0 auto; padding:18px;';\n\nconst shortReportId = escHtml(String(report_record_id || '').slice(-6));\n\nlet subject = '';\nlet emailBody = '';\n\nif (source_language === 'en') {\n  subject = `Document Request / ×“×¨×™×©×ª ××¡××›×™× - ${clientName} - ${year}`;\n\n  emailBody = `\n<div style=\"${containerStyle}\">\n  <div dir=\"ltr\" style=\"text-align:left; margin-bottom:40px;\">\n    <h2 style=\"color:#1a237e;\">Document Requirements for Tax Year ${escHtml(year)}</h2>\n    <p>Dear ${escHtml(clientName)},</p>\n    <p>Based on your input, please provide the following documents:</p>\n    <div style=\"background:#e3f2fd; padding:16px; border-radius:10px; border:1px solid #90caf9;\">${finalEnBlock}</div>\n    <div style=\"margin-top:14px; padding:12px; background:#f4f7f9; border-radius:10px;\">\n      <strong>How to submit?</strong><br>\n      Reply to this email with attachments or send to:\n      <a href=\"mailto:reports@moshe-atsits.co.il\" style=\"${linkStyle}\">reports@moshe-atsits.co.il</a>\n    </div>\n  </div>\n\n  <div style=\"border-top:3px solid #1976d2; margin:30px 0; position:relative;\">\n    <span style=\"position:absolute; top:-12px; left:50%; transform:translateX(-50%); background:white; padding:0 15px; color:#1976d2; font-weight:bold;\">\n      ×¢×‘×¨×™×ª / Hebrew\n    </span>\n  </div>\n\n  <div dir=\"rtl\" style=\"text-align:right;\">\n    <h2 style=\"color:#1a237e;\">×“×¨×™×©×ª ××¡××›×™× ×œ×©× ×ª ×”××¡ ${escHtml(year)}</h2>\n    <p>×©×œ×•× ${escHtml(clientName)},</p>\n    <p>×‘×”×ª×× ×œ×¤×¨×˜×™× ×©××¡×¨×ª, ××œ×• ×”××¡××›×™× ×©×¢×œ×™×š ×œ××¡×•×£:</p>\n    <div style=\"background:#fff3cd; padding:16px; border-radius:10px; border:1px solid #ffe2a8;\">${finalHeBlock}</div>\n    <div style=\"margin-top:14px; padding:12px; background:#f4f7f9; border-radius:10px;\">\n      <strong>××™×š ×©×•×œ×—×™×?</strong><br>\n      ×¤×©×•×˜ ×œ×”×©×™×‘ ×œ××™×™×œ ×–×” ×¢× ×”×§×‘×¦×™×, ××• ×œ×©×œ×•×— ×œ:\n      <a href=\"mailto:reports@moshe-atsits.co.il\" style=\"${linkStyle}\">reports@moshe-atsits.co.il</a>\n    </div>\n  </div>\n\n  <div style=\"${footerStyle}\">Moshe Atsits CPA â€¢ Report #${shortReportId}</div>\n</div>`;\n} else {\n  subject = `×“×¨×™×©×ª ××¡××›×™× ×œ×©× ×ª ${year} - ${clientName}`;\n\n  emailBody = `\n<div dir=\"rtl\" style=\"${containerStyle}\">\n  <h2 style=\"color:#1a237e;\">×“×¨×™×©×ª ××¡××›×™× ×œ×©× ×ª ×”××¡ ${escHtml(year)}</h2>\n  <p>×©×œ×•× ${escHtml(clientName)},</p>\n  <p>×‘×”×ª×× ×œ×¤×¨×˜×™× ×©××¡×¨×ª, ××œ×• ×”××¡××›×™× ×©×¢×œ×™×š ×œ××¡×•×£:</p>\n  <div style=\"background:#fff3cd; padding:16px; border-radius:10px; border:1px solid #ffe2a8;\">${finalHeBlock}</div>\n  <div style=\"margin-top:14px; padding:12px; background:#f4f7f9; border-radius:10px;\">\n    <strong>××™×š ×©×•×œ×—×™×?</strong><br>\n    × × ×œ×©×œ×•×— ××ª ×›×œ ×”××¡××›×™× ×œ××™×™×œ:\n    <a href=\"mailto:reports@moshe-atsits.co.il\" style=\"${linkStyle}\">reports@moshe-atsits.co.il</a>\n  </div>\n  <div style=\"${footerStyle}\">××©×¨×“ ×¨×•×´×— ××©×” ×¢×¦×™×¥ â€¢ ×©× ×ª ××¡ ${escHtml(year)} â€¢ ×“×•×´×— ${shortReportId}</div>\n</div>`;\n}\n\nreturn [\n  {\n    json: {\n      emailBody,\n      subject,\n      clientEmail,\n      report_record_id,\n      source_language,\n    },\n  },\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6576,
        32
      ],
      "id": "bef489f0-baa4-4e7e-a3a1-02e9bae53dea",
      "name": "HTML Generator"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.microsoft.com/v1.0/me/sendMail",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  message: {\n    subject: '×“×¨×™×©×ª ××¡××›×™× ×œ×“×•\"×— ×©× ×ª×™',\n    body: {\n      contentType: 'HTML',\n      content: $json.emailBody\n    },\n    toRecipients: [\n      {\n        emailAddress: {\n          address: $json.clientEmail\n        }\n      }\n    ]\n  }\n} }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6800,
        32
      ],
      "id": "1742a9e7-7d4d-4473-9032-addb6c4832b0",
      "name": "MS Graph - Send to Client",
      "credentials": {
        "oAuth2Api": {
          "id": "GcLQZwzH2xj41sV7",
          "name": "MS_Graph_CPA_Automation"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "list",
          "cachedResultName": "Annual Reports CRM",
          "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh"
        },
        "table": {
          "__rl": true,
          "value": "tbls7m3hmHC4hhQVy",
          "mode": "list",
          "cachedResultName": "annual_reports",
          "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh/tbls7m3hmHC4hhQVy"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('HTML Generator').item.json.report_record_id }}",
            "stage": "3-Collecting_Docs",
            "last_progress_check_at": "2026-01-08T10:49:21"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true
            },
            {
              "id": "report_key",
              "displayName": "report_key",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "client",
              "displayName": "client",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "array",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "send_questionnaire",
              "displayName": "send_questionnaire",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "year",
              "displayName": "year",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "number",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "stage",
              "displayName": "stage",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "options",
              "options": [
                {
                  "name": "1-Send_Questionnaire",
                  "value": "1-Send_Questionnaire"
                },
                {
                  "name": "2-Waiting_For_Answers",
                  "value": "2-Waiting_For_Answers"
                },
                {
                  "name": "3-Collecting_Docs",
                  "value": "3-Collecting_Docs"
                },
                {
                  "name": "4-Review",
                  "value": "4-Review"
                },
                {
                  "name": "5-Completed",
                  "value": "5-Completed"
                }
              ],
              "readOnly": false,
              "removed": false
            },
            {
              "id": "questionnaire_token",
              "displayName": "questionnaire_token",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "report_uid",
              "displayName": "report_uid",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "questionnaire_link_he",
              "displayName": "questionnaire_link_he",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "questionnaire_link_en",
              "displayName": "questionnaire_link_en",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "notes",
              "displayName": "notes",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "last_progress_check_at",
              "displayName": "last_progress_check_at",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "dateTime",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "documents",
              "displayName": "documents",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "array",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "email_events",
              "displayName": "email_events",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "array",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "docs_total",
              "displayName": "docs_total",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "docs_missing_count",
              "displayName": "docs_missing_count",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "docs_received_count",
              "displayName": "docs_received_count",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "completion_percent",
              "displayName": "completion_percent",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "completion_status_auto",
              "displayName": "completion_status_auto",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "client_id",
              "displayName": "client_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "record_id",
              "displayName": "record_id",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "client_email",
              "displayName": "client_email",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            },
            {
              "id": "client_name",
              "displayName": "client_name",
              "required": false,
              "defaultMatch": false,
              "canBeUsedToMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7024,
        32
      ],
      "id": "aeb24b4e-8155-4f30-a387-2fd128e75ccf",
      "name": "Airtable - Set Stage 3",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "<h1>×”××™×™×œ × ×©×œ×— ×œ×œ×§×•×— ×‘×”×¦×œ×—×”! ×”×¡×˜×˜×•×¡ ×‘××™×™×¨×˜×™×™×‘×œ ×¢×•×“×›×Ÿ.</h1>",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        7248,
        32
      ],
      "id": "4c96c7a8-a469-4c11-b9b8-31d67b495ddc",
      "name": "Success Page"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "08853ed8-ac8a-4532-9e4d-ff86b75bb981",
              "name": "WEBHOOK_SECRET",
              "value": "MOSHE_1710",
              "type": "string"
            },
            {
              "id": "34c52cd4-0bcd-4792-ba68-8c780d0a9652",
              "name": "INTERFACE_URL",
              "value": "LINK",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        5232,
        -64
      ],
      "id": "a545d7c9-e94d-4e30-af4c-116dd21ad77c",
      "name": "Global Config"
    },
    {
      "parameters": {
        "base": {
          "__rl": true,
          "value": "appqBL5RWQN9cPOyh",
          "mode": "list",
          "cachedResultName": "Annual Reports CRM",
          "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh"
        },
        "table": {
          "__rl": true,
          "value": "tbls7m3hmHC4hhQVy",
          "mode": "list",
          "cachedResultName": "annual_reports",
          "cachedResultUrl": "https://airtable.com/appqBL5RWQN9cPOyh/tbls7m3hmHC4hhQVy"
        },
        "id": "={{ $json.report_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        5680,
        -64
      ],
      "id": "b909a539-e21a-43d8-8c1f-9dc7198113d8",
      "name": "Get a record",
      "credentials": {
        "airtableTokenApi": {
          "id": "ODW07LgvsPQySQxh",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "8b7e0d1a-16c3-445c-9957-eeeed0339346",
              "leftValue": "{{ $json.stage }}",
              "rightValue": "3-Collecting_Docs",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        5904,
        -64
      ],
      "id": "3155203d-9342-45bb-9c33-7cc3200a61eb",
      "name": "If"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "×”×“×•\"×— ×›×‘×¨ ××•×©×¨ ×•× ×©×œ×— ×‘×¢×‘×¨.",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        6128,
        -160
      ],
      "id": "1bc1022e-ed4e-43c6-ba13-0fcefc5781bc",
      "name": "Already Approved"
    }
  ],
  "connections": {
    "Webhook - Approve": {
      "main": [
        [
          {
            "node": "Global Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Token": {
      "main": [
        [
          {
            "node": "Get a record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable - List Docs": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "HTML Generator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTML Generator": {
      "main": [
        [
          {
            "node": "MS Graph - Send to Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MS Graph - Send to Client": {
      "main": [
        [
          {
            "node": "Airtable - Set Stage 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Airtable - Set Stage 3": {
      "main": [
        [
          {
            "node": "Success Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Global Config": {
      "main": [
        [
          {
            "node": "Verify Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a record": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Already Approved",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Airtable - List Docs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Already Approved": {
      "main": [
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "pinData": {
    "Webhook - Approve": [
      {
        "json": {
          "headers": {
            "host": "liozshor.app.n8n.cloud",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
            "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
            "accept-encoding": "gzip, br",
            "accept-language": "he-IL,he;q=0.9,en-US;q=0.8,en;q=0.7",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "84.228.191.214",
            "cf-ew-via": "15",
            "cf-ipcountry": "IL",
            "cf-ray": "9bfd695ee76defea-TLV",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "cookie": "rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX18WrUYCEdyX7dvfVZUNSQ5OmIUwQaw%2F3Z8%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX18tHy%2Bd7IGjlhgEy7BVnA86hwVCXoRSsEw%3D; _ga=GA1.1.1581181506.1766250742; _gcl_au=1.1.2108227357.1766250793; _ga_0SC4FF2FH9=GS2.1.s1767522489$o5$g1$t1767524575$j60$l0$h0; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX19qfNU1WPg42SInj0aMu2mqEnPq9ErK8UEQ7bSrcPa0BR3u5%2Fs3i5zGB7nqTuny2xjKk7M3GSduQg%3D%3D; rl_user_id=RudderEncrypt%3AU2FsdGVkX1%2B4%2B%2BGpbyy3MfWbyLCJRliNfxp14QBFWRjXFa6Gtq%2FENtC%2F2kmzwEhNKFWuWKfdGMZUHF7MORNgDipNTJFCch5%2BU8N0V8ChyTwAS29rKzSYpxphrxwevGxOvgKzIBqskgJ3PsgrTZNdhn0Dvk1F5RYcC3QKRrthvkU%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX1%2Bhrp7kmFTVxRuzIIK8R%2Bm%2FX%2FXabhXDTauRnKxA3%2FXkeFurBdTaOb4TALb1SlhrKha5rp%2F12NcPLealUmryKXlECvKEw5kRcUS9W8oPQQEt7AKWwalmD05YLEY6NyR9injMiV8ahJSH8BlJatUMV4bUScGxvYsfTObzRR%2BFBEhmhFbt7528q0ygwgTYQqmQmmg5w%2BDsXgDOwQ%3D%3D; n8n_anonymous_id=87b50fe0-ce3b-4020-ba69-1252ca4e61ed; rl_session=RudderEncrypt%3AU2FsdGVkX1%2BhtjVPkzuQdnGasA7SCLkSls07j8iLvLE6iuQmM4AipHy55Hv7ReGC2xlAxBa13fnpkfE%2B66DcZuw%2BnegLovLjxtfpgx6jab%2FTSEzPJ3QWbCXuZeNEmsoUOaxq7825tcO0yHlnyKvIrQ%3D%3D; ph_phc_4URIAm1uYfJO7j8kWSe0J8lc8IqnstRLS7Jx8NcakHo_posthog=%7B%22%24device_id%22%3A%22019b745a-9093-77ba-8b30-639a859b91ca%22%2C%22distinct_id%22%3A%229c474c280b7e4477f9d75d768e7cdca622dfae61b628f544a69d021b088566ad%23759528d2-377e-4089-93c3-7a1aa04cf695%22%2C%22%24sesid%22%3A%5B1768732006277%2C%22019bd097-8697-73a7-90dc-0c008211893b%22%2C1768731149970%5D%2C%22%24epp%22%3Atrue%2C%22%24initial_person_info%22%3A%7B%22r%22%3A%22https%3A%2F%2Fliozshor.app.n8n.cloud%2Fsignin%22%2C%22u%22%3A%22https%3A%2F%2Fliozshor.app.n8n.cloud%2Fhome%2Fworkflows%22%7D%7D",
            "priority": "u=0, i",
            "sec-ch-ua": "\"Google Chrome\";v=\"143\", \"Chromium\";v=\"143\", \"Not A(Brand\";v=\"24\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "document",
            "sec-fetch-mode": "navigate",
            "sec-fetch-site": "cross-site",
            "sec-fetch-user": "?1",
            "upgrade-insecure-requests": "1",
            "x-forwarded-for": "84.228.191.214, 172.70.153.167",
            "x-forwarded-host": "liozshor.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-15-6cb64f5ddc-g6lcc",
            "x-is-trusted": "yes",
            "x-real-ip": "84.228.191.214"
          },
          "params": {},
          "query": {
            "report_id": "reci3TDgN6R42hhTl",
            "token": "29a2772ba348fd5cab2f5115ca9fd4aed188fda2df268764c88ac100cc8d4ea7"
          },
          "body": {},
          "webhookUrl": "https://liozshor.app.n8n.cloud/webhook/approve-and-send",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "triggerCount": 1,
  "meta": {
    "templateCredsSetupCompleted": true
  }
}