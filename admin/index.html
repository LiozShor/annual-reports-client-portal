<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פורטל ניהול - משרד רו"ח משה עציץ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📋</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="../assets/css/design-system.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-icon"><i data-lucide="lock" class="icon-xl"></i></div>
            <h1>פורטל ניהול</h1>
            <p>משרד רו"ח משה עציץ</p>
            <form onsubmit="login(); return false;">
                <input type="text" name="username" value="admin" autocomplete="username" style="display:none" aria-hidden="true">
                <input type="password" id="passwordInput" placeholder="הזן סיסמה" autocomplete="current-password">
            </form>
            <div id="loginError" class="login-error">סיסמה שגויה</div>
            <button class="btn btn-primary w-full" onclick="login()">
                <i data-lucide="zap" class="icon-sm"></i> כניסה
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="app">
        <!-- Persistent Navbar -->
        <nav class="admin-navbar">
            <div class="nav-brand">
                <i data-lucide="building-2" class="icon"></i>
                פורטל ניהול
            </div>
            <div class="nav-actions">
                <button class="btn btn-ghost btn-sm" onclick="refreshData()">
                    <i data-lucide="refresh-cw" class="icon-sm"></i> רענן
                </button>
                <button class="btn btn-ghost btn-sm" onclick="logout()">
                    <i data-lucide="log-out" class="icon-sm"></i> התנתק
                </button>
            </div>
        </nav>

        <div class="tabs-nav">
            <button class="tab-item active" onclick="switchTab('dashboard', event)"><i data-lucide="bar-chart-3" class="icon-sm"></i> לוח בקרה</button>
            <button class="tab-item" onclick="switchTab('import', event)"><i data-lucide="upload" class="icon-sm"></i> הוספת לקוחות</button>
            <button class="tab-item" onclick="switchTab('send', event)"><i data-lucide="mail" class="icon-sm"></i> שליחת שאלונים</button>
            <button class="tab-item" onclick="switchTab('review', event)">
                <i data-lucide="clipboard-check" class="icon-sm"></i> מוכנים לבדיקה
                <span class="review-count-badge" id="reviewCountBadge" style="display:none;">0</span>
            </button>
            <button class="tab-item" onclick="switchTab('ai-review', event)">
                <i data-lucide="scan-eye" class="icon-sm"></i> סקירת AI
                <span class="ai-review-tab-badge" id="aiReviewTabBadge" style="display:none;">0</span>
            </button>
        </div>

        <div class="content">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card" onclick="toggleStageFilter('')" ondblclick="toggleStageFilter('')">
                        <div class="stat-number" id="stat-total">-</div>
                        <div class="stat-label"><i data-lucide="users" class="icon-sm"></i> סה"כ לקוחות</div>
                    </div>
                    <div class="stat-card stage-1" onclick="toggleStageFilter('1')" ondblclick="toggleStageFilter('')">
                        <div class="stat-number" id="stat-stage1">-</div>
                        <div class="stat-label"><i data-lucide="clipboard-list" class="icon-sm"></i> ממתינים לשליחה</div>
                    </div>
                    <div class="stat-card stage-2" onclick="toggleStageFilter('2')" ondblclick="toggleStageFilter('')">
                        <div class="stat-number" id="stat-stage2">-</div>
                        <div class="stat-label"><i data-lucide="hourglass" class="icon-sm"></i> ממתינים לתשובה</div>
                    </div>
                    <div class="stat-card stage-3" onclick="toggleStageFilter('3')" ondblclick="toggleStageFilter('')">
                        <div class="stat-number" id="stat-stage3">-</div>
                        <div class="stat-label"><i data-lucide="folder-open" class="icon-sm"></i> אוספים מסמכים</div>
                    </div>
                    <div class="stat-card stage-4" onclick="toggleStageFilter('4')" ondblclick="toggleStageFilter('')">
                        <div class="stat-number" id="stat-stage4">-</div>
                        <div class="stat-label"><i data-lucide="search" class="icon-sm"></i> בבדיקה</div>
                    </div>
                    <div class="stat-card stage-5" onclick="toggleStageFilter('5')" ondblclick="toggleStageFilter('')">
                        <div class="stat-number" id="stat-stage5">-</div>
                        <div class="stat-label"><i data-lucide="circle-check" class="icon-sm"></i> הושלם</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i data-lucide="users" class="icon"></i> רשימת לקוחות</h2>
                        <button class="btn btn-secondary" onclick="exportToExcel()">
                            <i data-lucide="download" class="icon-sm"></i> ייצוא לאקסל
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="filters">
                            <div class="filter-group">
                                <label><i data-lucide="search" class="icon-sm"></i> חיפוש:</label>
                                <input type="text" id="searchInput" placeholder="חיפוש לפי שם..."
                                    oninput="filterClients()">
                            </div>
                            <div class="filter-group">
                                <label><i data-lucide="filter" class="icon-sm"></i> סינון:</label>
                                <select id="stageFilter" onchange="filterClients()">
                                    <option value="">הכל</option>
                                    <option value="1">ממתינים לשליחה</option>
                                    <option value="2">ממתינים לתשובה</option>
                                    <option value="3">אוספים מסמכים</option>
                                    <option value="4">בבדיקה</option>
                                    <option value="5">הושלם</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label><i data-lucide="calendar" class="icon-sm"></i> שנה:</label>
                                <select id="yearFilter" onchange="filterClients()">
                                    <option value="">הכל</option>
                                    <option value="2025" selected>2025</option>
                                </select>
                            </div>
                        </div>

                        <div id="clientsTableContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i data-lucide="bar-chart" class="icon-2xl"></i></div>
                                <p>טוען נתונים...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Import Tab -->
            <div id="tab-import" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i data-lucide="upload" class="icon"></i> הוספת לקוחות</h2>
                        <div class="header-actions">
                            <button class="btn btn-secondary" id="btn-mode-manual" onclick="setAddMode('manual')"><i
                                    data-lucide="plus" class="icon-sm"></i> הוספה ידנית</button>
                            <button class="btn btn-primary" id="btn-mode-import" onclick="setAddMode('import')"
                                disabled><i data-lucide="file-spreadsheet" class="icon-sm"></i> ייבוא מאקסל</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Manual Section -->
                        <div id="section-manual" class="manual-section">
                            <div class="manual-form">
                                <div class="form-field">
                                    <label class="form-label">שם מלא:</label>
                                    <input type="text" id="manualName" placeholder="ישראל ישראלי">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">אימייל:</label>
                                    <input type="text" id="manualEmail" placeholder="israel@example.com">
                                </div>
                                <div class="form-field">
                                    <label class="form-label">שנת דוח:</label>
                                    <select id="manualYear">
                                        <option value="2025" selected>2025</option>
                                    </select>
                                </div>
                                <button class="btn btn-success w-full" onclick="addManualClient()">
                                    <i data-lucide="zap" class="icon-sm"></i> הוסף למערכת
                                </button>
                            </div>
                        </div>

                        <!-- Import Section -->
                        <div id="section-import">
                            <div class="upload-zone" id="uploadZone"
                                onclick="document.getElementById('fileInput').click()">
                                <div class="upload-zone-icon"><i data-lucide="upload-cloud" class="icon-2xl"></i></div>
                                <h3>גרור קובץ Excel לכאן</h3>
                                <p>או לחץ לבחירת קובץ</p>
                                <button class="btn btn-primary"><i data-lucide="paperclip" class="icon-sm"></i> בחר
                                    קובץ</button>
                                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv"
                                    onchange="handleFileSelect(event)">
                            </div>

                            <div class="import-options">
                                <h4><i data-lucide="list-checks" class="icon-sm"></i> פורמט נדרש:</h4>
                                <p>קובץ Excel עם שתי עמודות:</p>
                                <table class="table mt-3">
                                    <thead>
                                        <tr>
                                            <th>name</th>
                                            <th>email</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>משה כהן</td>
                                            <td>moshe@example.com</td>
                                        </tr>
                                        <tr>
                                            <td>שרה לוי</td>
                                            <td>sara@example.com</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div id="previewSection" class="preview-section">
                                <div class="preview-header">
                                    <h2><i data-lucide="eye" class="icon"></i> תצוגה מקדימה</h2>
                                </div>

                                <div class="preview-stats">
                                    <div class="preview-stat">
                                        <strong id="preview-total">0</strong>
                                        <span> שורות נמצאו</span>
                                    </div>
                                    <div class="preview-stat">
                                        <strong id="preview-valid">0</strong>
                                        <span> תקינים</span>
                                    </div>
                                    <div class="preview-stat error">
                                        <strong id="preview-errors">0</strong>
                                        <span> שגיאות</span>
                                    </div>
                                    <div class="preview-stat warning">
                                        <strong id="preview-duplicates">0</strong>
                                        <span> כפולים (יידלגו)</span>
                                    </div>
                                </div>

                                <div class="import-options">
                                    <h4><i data-lucide="settings" class="icon-sm"></i> הגדרות ייבוא:</h4>
                                    <div class="option-row">
                                        <label><i data-lucide="calendar" class="icon-sm"></i> שנת דוח:</label>
                                        <select id="importYear">
                                            <option value="2025" selected>2025</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="table-wrapper mt-4">
                                    <table id="previewTable" class="table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>שם</th>
                                                <th>אימייל</th>
                                                <th>סטטוס</th>
                                            </tr>
                                        </thead>
                                        <tbody id="previewTableBody"></tbody>
                                    </table>
                                </div>

                                <div class="preview-actions">
                                    <button class="btn btn-success" id="importBtn" onclick="startImport()">
                                        <i data-lucide="check" class="icon-sm"></i> ייבא <span id="importCount">0</span>
                                        לקוחות
                                    </button>
                                    <button class="btn btn-secondary" onclick="clearPreview()">
                                        <i data-lucide="x" class="icon-sm"></i> בטל
                                    </button>
                                </div>
                            </div>
                        </div> <!-- End Import Section -->
                    </div>
                </div>
            </div>

            <!-- Send Questionnaires Tab -->
            <div id="tab-send" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i data-lucide="send" class="icon"></i> שליחת שאלונים</h2>
                    </div>
                    <div class="card-body">
                        <div class="filters">
                            <div class="filter-group">
                                <label><i data-lucide="calendar" class="icon-sm"></i> שנה:</label>
                                <select id="sendYearFilter">
                                    <option value="2025" selected>2025</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="loadPendingClients()">
                                <i data-lucide="refresh-cw" class="icon-sm"></i> טען לקוחות ממתינים
                            </button>
                        </div>

                        <div id="pendingClientsContainer">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i data-lucide="inbox" class="icon-2xl"></i></div>
                                <p>טוען נתונים...</p>
                            </div>
                        </div>

                        <div id="sendActions" class="send-actions">
                            <button class="btn btn-success" onclick="sendToSelected()">
                                <i data-lucide="send" class="icon-sm"></i> שלח לנבחרים (<span id="selectedCount">0</span>)
                            </button>
                            <button class="btn btn-primary" onclick="sendToAll()">
                                <i data-lucide="mail" class="icon-sm"></i> שלח לכולם
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Tab -->
            <div id="tab-review" class="tab-content">
                <div class="review-header-bar">
                    <div class="review-header-info">
                        <h2><i data-lucide="clipboard-check" class="icon"></i> מוכנים לבדיקה</h2>
                        <span class="review-header-count" id="reviewHeaderCount">0 לקוחות בתור</span>
                    </div>
                    <div class="review-header-actions">
                        <button class="btn btn-secondary" onclick="exportReviewToExcel()">
                            <i data-lucide="download" class="icon-sm"></i> ייצוא לאקסל
                        </button>
                    </div>
                </div>
                <p class="review-fifo-hint"><i data-lucide="info" class="icon-sm"></i> הרשימה ממוינת לפי סדר השלמה — מי שסיים ראשון מופיע ראשון (FIFO)</p>

                <div id="reviewTableContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon"><i data-lucide="inbox" class="icon-2xl"></i></div>
                        <p>אין לקוחות מוכנים לבדיקה כרגע</p>
                    </div>
                </div>
            </div>

            <!-- AI Review Tab -->
            <div id="tab-ai-review" class="tab-content">
                <!-- Stats Bar -->
                <div class="ai-stats-bar">
                    <div class="ai-stat-item ai-stat-pending">
                        <i data-lucide="clock" class="icon-sm"></i>
                        <span class="ai-stat-value" id="ai-stat-pending">0</span>
                        <span class="ai-stat-label">ממתינים</span>
                    </div>
                    <div class="ai-stat-item ai-stat-matched">
                        <i data-lucide="link" class="icon-sm"></i>
                        <span class="ai-stat-value" id="ai-stat-matched">0</span>
                        <span class="ai-stat-label">זוהו</span>
                    </div>
                    <div class="ai-stat-item ai-stat-unmatched">
                        <i data-lucide="unlink" class="icon-sm"></i>
                        <span class="ai-stat-value" id="ai-stat-unmatched">0</span>
                        <span class="ai-stat-label">לא זוהו</span>
                    </div>
                    <div class="ai-stat-item ai-stat-high-conf">
                        <i data-lucide="shield-check" class="icon-sm"></i>
                        <span class="ai-stat-value" id="ai-stat-high-confidence">0</span>
                        <span class="ai-stat-label">ביטחון גבוה</span>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="ai-filter-bar">
                    <div class="filter-group">
                        <label><i data-lucide="search" class="icon-sm"></i></label>
                        <input type="text" id="aiSearchInput" placeholder="חיפוש לפי שם לקוח..." oninput="applyAIFilters()">
                    </div>
                    <div class="filter-group">
                        <label><i data-lucide="gauge" class="icon-sm"></i> ביטחון:</label>
                        <select id="aiConfidenceFilter" onchange="applyAIFilters()">
                            <option value="">הכל</option>
                            <option value="high">גבוה (85%+)</option>
                            <option value="medium">בינוני (50-84%)</option>
                            <option value="low">נמוך (&lt;50%)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label><i data-lucide="filter" class="icon-sm"></i> סוג:</label>
                        <select id="aiTypeFilter" onchange="applyAIFilters()">
                            <option value="">הכל</option>
                            <option value="matched">זוהו</option>
                            <option value="unmatched">לא זוהו</option>
                        </select>
                    </div>
                </div>

                <!-- Accordion Container -->
                <div id="aiCardsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon"><i data-lucide="scan-eye" class="icon-2xl"></i></div>
                        <p>לחץ על הלשונית לטעינת סקירות AI</p>
                    </div>
                </div>

                <!-- Empty State (when all reviewed) -->
                <div id="aiEmptyState" class="ai-empty-done" style="display: none;">
                    <div class="ai-empty-done-icon"><i data-lucide="circle-check-big" class="icon-2xl"></i></div>
                    <h2>אין סיווגים ממתינים לבדיקה</h2>
                    <p>כל המסמכים סווגו ואושרו בהצלחה</p>
                    <button class="btn btn-secondary mt-4" onclick="loadAIClassifications()">
                        <i data-lucide="refresh-cw" class="icon-sm"></i> בדוק שוב
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-box">
            <div class="spinner spinner-lg"></div>
            <p id="loadingText">מעבד...</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"><i data-lucide="circle-check" class="icon-2xl"></i></div>
            <h2 class="modal-title" id="modalTitle">הושלם בהצלחה!</h2>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-stats" id="modalStats"></div>
            <button class="btn btn-primary" onclick="closeModal()">סגור</button>
        </div>
    </div>

    <!-- AI Reassign Modal -->
    <div id="aiReassignModal" class="ai-modal-overlay">
        <div class="ai-modal-panel">
            <div class="ai-modal-panel-header">
                <i data-lucide="arrow-right-left" class="icon"></i>
                שיוך מסמך למסמך אחר
            </div>
            <div class="ai-modal-panel-body">
                <p class="mb-3">בחר את המסמך הנכון מרשימת המסמכים החסרים של הלקוח:</p>
                <div class="ai-reassign-file-info mb-4" id="aiReassignFileInfo"></div>
                <label class="form-label">מסמך יעד:</label>
                <div id="aiReassignComboboxContainer"></div>
            </div>
            <div class="ai-modal-panel-footer">
                <button class="btn btn-secondary" onclick="closeAIReassignModal()">ביטול</button>
                <button class="btn btn-primary" id="aiReassignConfirmBtn" onclick="confirmAIReassign()" disabled>
                    <i data-lucide="check" class="icon-sm"></i> שייך
                </button>
            </div>
        </div>
    </div>

    <!-- AI Toast -->
    <div id="aiToast" class="ai-toast">
        <i data-lucide="check-circle" class="icon-sm" id="aiToastIcon"></i>
        <span id="aiToastText"></span>
    </div>

    <!-- Confirm Dialog -->
    <div id="confirmDialog" class="ai-modal-overlay">
        <div class="ai-modal-panel confirm-dialog-panel">
            <div class="ai-modal-panel-header">
                <i data-lucide="alert-triangle" class="icon"></i>
                <span id="confirmDialogTitle">אישור פעולה</span>
            </div>
            <div class="ai-modal-panel-body">
                <p id="confirmDialogMessage"></p>
            </div>
            <div class="ai-modal-panel-footer">
                <button class="btn btn-primary" id="confirmDialogBtn" onclick="closeConfirmDialog(true)">אישור</button>
                <button class="btn btn-secondary" onclick="closeConfirmDialog(false)">ביטול</button>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script src="js/script.js"></script>
</body>

</html>
