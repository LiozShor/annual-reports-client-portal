<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>העלאת מסמכים חסרים | משה ציץ - רואה חשבון</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --bg-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #dee2e6;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .submit-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        #messageArea {
            margin-top: 20px;
            display: none;
        }

        .progress {
            height: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Detail inputs styling */
        .detail-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>העלאת מסמך חסר</h1>
            <p>אנא בחרו את סוג המסמך והעלו את הקובץ המתאים</p>
        </div>

        <form id="uploadForm">
            <input type="hidden" id="report_id" name="report_id">
            <input type="hidden" id="client_id" name="client_id">
            <input type="hidden" id="token" name="token">

            <div class="form-group">
                <label for="docTypeSelect">סוג המסמך</label>
                <select class="form-select" id="docTypeSelect" required>
                    </select>
            </div>

            <div id="detailsContainer" class="detail-group hidden">
                </div>

            <div class="form-group">
                <label for="fileInput">קובץ (PDF או תמונה)</label>
                <input type="file" class="form-control" id="fileInput" name="file" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>

            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                שליחת מסמך
            </button>
        </form>

        <div id="messageArea" class="alert" role="alert"></div>
    </div>

    <script type="module">
        import { getDocumentDropdownOptions, getDetailsSchema, requiresDetails } from './document-types.js';

        // --- Configuration ---
        const WEBHOOK_URL = 'https://automation.moshe-cpa.com/webhook/tally-edit-documents'; // Production URL
        
        // --- DOM Elements ---
        const form = document.getElementById('uploadForm');
        const docTypeSelect = document.getElementById('docTypeSelect');
        const detailsContainer = document.getElementById('detailsContainer');
        const submitBtn = document.getElementById('submitBtn');
        const messageArea = document.getElementById('messageArea');
        const progressBar = document.querySelector('.progress');
        const progressBarInner = document.querySelector('.progress-bar');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Get URL Parameters
            const urlParams = new URLSearchParams(window.location.search);
            document.getElementById('report_id').value = urlParams.get('report_id') || '';
            document.getElementById('client_id').value = urlParams.get('client_id') || '';
            document.getElementById('token').value = urlParams.get('token') || '';

            // 2. Populate Dropdown from Single Source of Truth
            if (docTypeSelect) {
                docTypeSelect.innerHTML = '<option value="" disabled selected>בחר/י סוג מסמך...</option>' + 
                                          getDocumentDropdownOptions({ includeCategoryGroups: true });
                
                docTypeSelect.addEventListener('change', updateDetailsFields);
            }
        });

        // --- Dynamic Fields Logic ---
        function updateDetailsFields() {
            const docType = docTypeSelect.value;
            
            // Clear previous fields
            detailsContainer.innerHTML = '';
            detailsContainer.classList.add('hidden');

            if (!docType || !requiresDetails(docType)) return;

            // Render new fields
            detailsContainer.classList.remove('hidden');
            const schema = getDetailsSchema(docType);

            schema.forEach(field => {
                const wrapper = document.createElement('div');
                wrapper.className = 'form-group fade-in mb-3';
                
                const label = document.createElement('label');
                label.innerText = field.label_he;
                label.htmlFor = `detail_${field.key}`;
                wrapper.appendChild(label);

                let input;
                if (field.type === 'select') {
                    input = document.createElement('select');
                    input.className = 'form-select';
                    input.innerHTML = `<option value="" disabled selected>בחר/י...</option>` + 
                        field.options_he.map((opt, idx) => 
                            `<option value="${opt}">${opt}</option>` // Passing Hebrew value currently
                        ).join('');
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'form-control';
                    input.placeholder = field.placeholder_he || '';
                }

                input.id = `detail_${field.key}`;
                input.name = field.key; // Used to collect data later
                input.required = true;
                input.dataset.isDetail = "true"; // Marker
                
                wrapper.appendChild(input);
                detailsContainer.appendChild(wrapper);
            });
        }

        // --- Upload Logic ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate URL params
            const reportId = document.getElementById('report_id').value;
            if (!reportId) {
                showMessage('שגיאה: חסר מזהה דוח בקישור. נא להיכנס דרך הקישור שנשלח במייל.', 'danger');
                return;
            }

            // UI Reset
            submitBtn.disabled = true;
            submitBtn.innerText = 'מעלה...';
            messageArea.style.display = 'none';
            progressBar.style.display = 'block';
            progressBarInner.style.width = '0%';

            try {
                const formData = new FormData();
                
                // 1. Add Standard Fields
                formData.append('report_id', reportId);
                formData.append('client_id', document.getElementById('client_id').value);
                formData.append('token', document.getElementById('token').value);
                formData.append('action', 'add'); // Explicit action
                
                const docType = docTypeSelect.value;
                formData.append('doc_type', docType);

                // 2. Add File
                const fileInput = document.getElementById('fileInput');
                if (fileInput.files.length > 0) {
                    formData.append('file', fileInput.files[0]);
                }

                // 3. Add Dynamic Details (as JSON string)
                const detailInputs = detailsContainer.querySelectorAll('[data-is-detail="true"]');
                const detailsObj = {};
                detailInputs.forEach(input => {
                    if (input.value) {
                        detailsObj[input.name] = input.value;
                    }
                });
                
                if (Object.keys(detailsObj).length > 0) {
                    formData.append('document_details', JSON.stringify(detailsObj));
                }

                // 4. Send Request (XHR for progress tracking)
                await uploadWithProgress(WEBHOOK_URL, formData);

                showMessage('המסמך הועלה בהצלחה!', 'success');
                setTimeout(() => {
                    // Reset form but keep IDs
                    form.reset();
                    document.getElementById('report_id').value = reportId; // Restore ID
                    detailsContainer.innerHTML = '';
                    detailsContainer.classList.add('hidden');
                    submitBtn.disabled = false;
                    submitBtn.innerText = 'שליחת מסמך';
                    progressBar.style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('Upload error:', error);
                showMessage('שגיאה בהעלאת המסמך: ' + error.message, 'danger');
                submitBtn.disabled = false;
                submitBtn.innerText = 'שליחת מסמך';
                progressBar.style.display = 'none';
            }
        });

        // Helper: Upload with XHR to track progress
        function uploadWithProgress(url, formData) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBarInner.style.width = percent + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        resolve(xhr.response);
                    } else {
                        reject(new Error(`Server responded with ${xhr.status}`));
                    }
                });

                xhr.addEventListener('error', () => reject(new Error('Network error')));
                
                xhr.open('POST', url);
                xhr.send(formData);
            });
        }

        // Helper: Show Alert
        function showMessage(text, type) {
            messageArea.className = `alert alert-${type}`;
            messageArea.innerText = text;
            messageArea.style.display = 'block';
        }
    </script>
</body>
</html>
