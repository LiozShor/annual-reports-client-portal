<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מסמכים</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📋</text></svg>">
    <link rel="stylesheet" href="assets/css/design-system.css">
    <link rel="stylesheet" href="assets/css/common.css">
    <link rel="stylesheet" href="assets/css/document-manager.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" defer></script>
</head>
<body>
    <noscript>
        <div class="noscript-fallback">
            <h2>JavaScript Required / נדרש JavaScript</h2>
            <p>דף זה דורש JavaScript כדי לפעול. אנא הפעילו JavaScript בדפדפן או פנו למשרד:</p>
            <p>This page requires JavaScript. Please enable JavaScript or contact the office:</p>
            <p><a href="mailto:reports@moshe-atsits.co.il">reports@moshe-atsits.co.il</a></p>
        </div>
    </noscript>
    <div class="page-wrapper">
        <div class="container">
            <!-- Header bar -->
            <div class="page-header">
                <a href="admin/index.html" class="btn btn-ghost btn-sm">
                    <i data-lucide="arrow-right" class="icon-sm"></i>
                    חזרה לפורטל ניהול
                </a>
                <div class="header-title-row">
                    <i data-lucide="folder-open" class="icon-lg"></i>
                    <div>
                        <h1>ניהול מסמכים</h1>
                        <p class="text-muted text-sm">משרד רו״ח משה עציץ</p>
                    </div>
                </div>
            </div>

            <!-- Collapsible instructions -->
            <div class="instructions-section">
                <button class="collapsible-trigger" onclick="this.setAttribute('aria-expanded', this.getAttribute('aria-expanded')==='true'?'false':'true'); this.nextElementSibling.classList.toggle('open')" aria-expanded="false">
                    <span class="flex items-center gap-2">
                        <i data-lucide="lightbulb" class="icon-sm"></i>
                        איך להשתמש במערכת?
                    </span>
                    <i data-lucide="chevron-down" class="icon-sm"></i>
                </button>
                <div class="collapsible-content">
                    <div class="instructions-body">
                        <ul class="instruction-list">
                            <li><strong>הסרת מסמכים:</strong> סמן את התיבות ליד מסמכים שאינם רלוונטיים</li>
                            <li><strong>שחזור מסמכים:</strong> מסמכים שהוסרו מוצגים עם תיבת סימון כחולה</li>
                            <li><strong>שינוי סטטוס:</strong> לחץ על תג הסטטוס כדי לשנות</li>
                            <li><strong>הערות למסמך:</strong> לחץ על אייקון ההערה</li>
                            <li><strong>הוסף מסמכים:</strong> בחר מהרשימה או הזן שם מותאם אישית</li>
                            <li><strong>שמור שינויים:</strong> לחץ על "שמור שינויים"</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="alert" class="alert" style="display:none;"></div>

            <!-- Client info bar -->
            <div class="client-bar">
                <div class="client-bar-item">
                    <i data-lucide="user" class="icon-sm"></i>
                    <span class="text-muted text-sm">שם לקוח:</span>
                    <strong id="clientName">-</strong>
                </div>
                <div class="client-bar-item">
                    <i data-lucide="heart" class="icon-sm"></i>
                    <span class="text-muted text-sm">בן/בת זוג:</span>
                    <strong id="spouseName">-</strong>
                </div>
                <div class="client-bar-item">
                    <i data-lucide="calendar" class="icon-sm"></i>
                    <span class="text-muted text-sm">שנת מס:</span>
                    <strong id="year">-</strong>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>טוען מסמכים...</p>
            </div>

            <!-- Not started view -->
            <div id="not-started-view" class="not-started-view" style="display:none;">
                <i data-lucide="pencil" class="icon-2xl"></i>
                <h2>שאלון טרם מולא</h2>
                <p>ללקוח זה עדיין אין תיק מסמכים מכיוון שטרם מילא את השאלון השנתי.</p>
                <button onclick="confirmSendQuestionnaire()" class="btn btn-primary btn-lg">
                    <i data-lucide="send" class="icon-sm"></i>
                    שלח שאלון ללקוח
                </button>
            </div>

            <!-- Main content -->
            <div id="content" style="display:none;">
                <!-- Status Overview -->
                <div id="statusOverview" class="status-overview" style="display:none;">
                    <div class="status-overview-header">
                        <span class="text-sm font-semibold">סטטוס מסמכים</span>
                        <span id="statusSummaryText" class="text-sm text-muted"></span>
                    </div>
                    <div class="progress-bar-stacked" id="progressBarStacked" role="progressbar" aria-label="התקדמות מסמכים">
                        <div class="progress-segment progress-segment-received" id="segReceived" style="width:0%"></div>
                        <div class="progress-segment progress-segment-fix" id="segFix" style="width:0%"></div>
                        <div class="progress-segment progress-segment-missing" id="segMissing" style="width:0%"></div>
                        <div class="progress-segment progress-segment-waived" id="segWaived" style="width:0%"></div>
                    </div>
                    <div class="status-count-boxes">
                        <div class="status-count-box status-count-total active" data-status="" onclick="toggleStatusFilter('')" ondblclick="toggleStatusFilter('')">
                            <strong id="countTotal">0</strong>
                            <span>סה"כ</span>
                        </div>
                        <div class="status-count-box status-count-received" data-status="Received" onclick="toggleStatusFilter('Received')" ondblclick="toggleStatusFilter('')">
                            <strong id="countReceived">0</strong>
                            <span>התקבל</span>
                        </div>
                        <div class="status-count-box status-count-missing" data-status="Required_Missing" onclick="toggleStatusFilter('Required_Missing')" ondblclick="toggleStatusFilter('')">
                            <strong id="countMissing">0</strong>
                            <span>חסר</span>
                        </div>
                        <div class="status-count-box status-count-fix" data-status="Requires_Fix" onclick="toggleStatusFilter('Requires_Fix')" ondblclick="toggleStatusFilter('')">
                            <strong id="countFix">0</strong>
                            <span>נדרש תיקון</span>
                        </div>
                        <div class="status-count-box status-count-waived" data-status="Waived" onclick="toggleStatusFilter('Waived')" ondblclick="toggleStatusFilter('')">
                            <strong id="countWaived">0</strong>
                            <span>ויתור</span>
                        </div>
                    </div>

                    <!-- Edit session pills (shown only when changes pending) -->
                    <div id="editSessionBar" class="edit-session-bar" style="display:none;">
                        <div class="edit-session-divider"></div>
                        <div class="edit-session-pills">
                            <span class="stat-pill">
                                <i data-lucide="file-text" class="icon-sm"></i>
                                <strong id="totalDocs">0</strong> נדרשים
                            </span>
                            <span class="stat-pill stat-pill-danger">
                                <i data-lucide="circle-x" class="icon-sm"></i>
                                <strong id="markedDocs">0</strong> להסרה
                            </span>
                            <span class="stat-pill stat-pill-success">
                                <i data-lucide="plus" class="icon-sm"></i>
                                <strong id="addedDocs">0</strong> להוספה
                            </span>
                            <span class="stat-pill stat-pill-info">
                                <i data-lucide="refresh-cw" class="icon-sm"></i>
                                <strong id="restoredDocs">0</strong> לשחזור
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Document list -->
                <div id="existingDocs" class="document-list"></div>

                <!-- Add documents section -->
                <div class="add-section">
                    <button class="collapsible-trigger" onclick="this.setAttribute('aria-expanded', this.getAttribute('aria-expanded')==='true'?'false':'true'); this.nextElementSibling.classList.toggle('open')" aria-expanded="false">
                        <span class="flex items-center gap-2">
                            <i data-lucide="plus" class="icon-sm"></i>
                            הוספת מסמכים
                        </span>
                        <i data-lucide="chevron-down" class="icon"></i>
                    </button>
                    <div class="collapsible-content">
                    <p class="text-sm text-muted mb-4" style="margin-top: var(--sp-4);">בחר מסמכים מהרשימה או הוסף מסמך מותאם אישית</p>

                    <div class="form-group mb-4">
                        <label class="form-label" for="docTypeSelect">בחר מסמכים להוספה</label>
                        <select id="docTypeSelect">
                            <option value="">-- בחר מסמך מהרשימה --</option>
                        </select>

                        <div id="detailInput" class="detail-input">
                            <label id="detailLabel" class="form-label">פרטים נוספים:</label>
                            <input type="text" id="detailValue" placeholder="לדוגמה: שם המעסיק, שם הבנק, וכו'">
                            <button onclick="addDocumentWithDetail()" class="btn btn-success btn-sm mt-2">
                                <i data-lucide="plus" class="icon-sm"></i> הוסף מסמך
                            </button>
                        </div>
                    </div>

                    <div id="selectedDocs" class="selected-docs empty"></div>

                    <div class="form-group mb-4">
                        <label class="form-label">
                            <i data-lucide="pen-line" class="icon-sm"></i>
                            מסמך מותאם אישית
                        </label>
                        <input type="text" id="customDoc" placeholder="לדוגמה: אישור מיוחד מהמוסד לביטוח לאומי..."
                            onblur="checkCustomDocDuplicate()">
                        <div id="customDocWarning" class="alert alert-warning mt-2" style="display:none;">
                            שים לב: מסמך זה כבר נבחר ברשימה למעלה
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label class="form-label">
                            <i data-lucide="message-square" class="icon-sm"></i>
                            הערות נוספות
                        </label>
                        <textarea id="notes" placeholder="לדוגמה: נא לבקש את המסמכים ב-PDF בלבד..."></textarea>
                    </div>

                    <div class="email-toggle">
                        <label class="switch">
                            <input type="checkbox" id="emailToggle" checked onchange="sendEmailOnSave = this.checked">
                            <span class="switch-slider"></span>
                        </label>
                        <label for="emailToggle" class="text-sm">שלח אימייל התראה למשרד לאחר השמירה</label>
                    </div>

                    <div class="actions-row">
                        <button class="btn btn-primary btn-lg" onclick="openConfirmation()">
                            <i data-lucide="save" class="icon-sm"></i> שמור שינויים
                        </button>
                        <button class="btn btn-ghost" onclick="resetForm()">
                            <i data-lucide="refresh-cw" class="icon-sm"></i> אפס טופס
                        </button>
                    </div>
                    </div><!-- /.collapsible-content -->
                </div>
            </div>

            <!-- Success message -->
            <div id="success-message" class="success-view" style="display:none;">
                <i data-lucide="circle-check" class="icon-2xl"></i>
                <h2>הבקשה נשלחה בהצלחה!</h2>
                <p>רשימת המסמכים עודכנה והודעה נשלחה למשרד.</p>
                <p class="text-sm text-muted mt-2">אתה יכול לסגור את הדף כעת.</p>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal-panel">
            <div class="modal-panel-header">
                <i data-lucide="alert-triangle" class="icon-lg" style="color:var(--warning-500)"></i>
                אישור שינויים
            </div>
            <div class="modal-panel-body">
                <p class="mb-4">אנא אשר את השינויים הבאים:</p>
                <div id="changesSummary" class="changes-summary"></div>
                <div class="alert alert-warning mt-4">
                    <strong>הבהרה:</strong> הסרת מסמכים: סמן את התיבות ליד מסמכים לא רלוונטיים — הם יוסרו מרשימת המסמכים של הלקוח
                </div>
                <p class="text-sm text-muted mt-3">
                    <strong>שים לב:</strong> לאחר שמירת השינויים, יישלח אימייל אוטומטי למשרד הרואה חשבון עם פירוט השינויים.
                </p>
            </div>
            <div class="modal-panel-footer">
                <button class="btn btn-ghost" onclick="closeConfirmation()">ביטול</button>
                <button class="btn btn-primary" onclick="confirmSubmit()">
                    <i data-lucide="circle-check" class="icon-sm"></i> אישור ושליחה
                </button>
            </div>
        </div>
    </div>

    <!-- Status dropdown -->
    <div id="statusDropdown" class="status-dropdown" style="display:none;">
        <div class="dropdown-option" data-status="Required_Missing" onclick="setDocStatus('Required_Missing')">
            <span class="badge badge-danger">חסר</span>
        </div>
        <div class="dropdown-option" data-status="Received" onclick="setDocStatus('Received')">
            <span class="badge badge-success">התקבל</span>
        </div>
        <div class="dropdown-option" data-status="Requires_Fix" onclick="setDocStatus('Requires_Fix')">
            <span class="badge badge-warning">נדרש תיקון</span>
        </div>
    </div>

    <script src="assets/js/error-handler.js"></script>
    <script src="assets/js/resilient-fetch.js"></script>
    <script src="assets/js/document-manager.js"></script>
</body>
</html>
